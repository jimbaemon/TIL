# 왕초보도 따라하는 도커 기초

## 도커 설치하기

```
# sudo -i //root 권한 획득
# apt install docker.io //docker 설치
# docker //도커 도움말
```

```
//서비스 올리기 
#docker search tomcat //이미지 검색
# docker run -d -p 8080:8080 --name [이름] [검색에나온명] 
```

* -d : 백그라운드 실행
* -p : 포트 지정
* --name : 이름 지정

```
//톰캣 설치
# docker run -d -p 8080:8080 --name tc consol/tomcat-7.0
```



## 내가 원하는 이미지 찾기 도커 레지스트리

* 도커 레지스트리에는 사용자가 사용할 수 있도록 데이터베이스를 통해 Image를 제공해주고 있음 누구나 이미지를 만들어 푸시할 수 있으며 푸시된 이미지는 다른 사람들에게 공유 가능하다.
* 이미지를 컨테이너로 만드는 것은 별개이다

![image-20210130221614582](http://www.jimbae.com:59005/image/86) 

* https://hub.docker.com/

![image-20210130221904489](http://www.jimbae.com:59005/image/87)

* 앞에 / 가 안붙으면 Docker 에서 official 로 제공하는 이미지, / 가 붙어있으면 개인이 업로드 하는 이미지



//mysql 이미지 내려 받기

```
# docker pull mysql
```



## 도커 라이프 사이클 이해하기

![image-20210130224833324](http://www.jimbae.com:59005/image/88)

* **Registry**: 도커의 이미지 저장소
  * **PULL** : registry 로 부터 저장된 이미지를 받는다
  * **PUSH** : 저장된 이미지를 Registry 에 저장하는 역활
* **Image** : 사용할 이미지
  * **CREATE**: 이미지를 이용해 컨테이너를 생성하는 작업
  * **COMMIT**: 사용하는 컨테이너를 이미지로 변환하는 작업
  * **RMI**: 이미지 제거 명령어
    * -f : 컨테이너가 존재하더라도 이미지만 제거 하고 싶을때 
* **Container**: 컨테이너
  * **START**: 컨테이너를 실행
  * **RM**: 컨테이너 제거
* **Memory**: 실행중인 메모리 (도커랑 상관없다 그냥 메모리다..)
  * **STOP**: 실행중이 도커 멈추기
  * **RUN** : Image 를 다운로드 하여CREATE 하고 Start 까지 한번에 해주는 명령어 이미지가 있다면 CREATE 후 START 만 진행한다
    * 주의사항 : RUN 으로 컨테이너 실행시 이미지로 신규 컨테이너를 생성하여 실행하는 것이기 때문에 메모리 낭비가 있을수 있다.



## 실습

### 도커 이미지 다운로드와 삭제

```bash
sudo docker pull consol/tomcat-7.0
sudo docker rmi consol/tomcat-7.0 
```



### 톰캣 컨테이너 생성

```bash
sudo docker run -d --name tc tomcat #톰캣 생성 및 실행
```



### 실행중인 컨테이너 확인

```bash
sudo docker ps #톰캣 컨테이너 확인
```



### 모든 컨테이너 확인

```bash
sudo dokcer ps -a #모든 컨테이너 확인
```



### 컨테이너 중지

```bash
sudo docker stop f6e513b3999a6 # 컨테이너 중지
```



### 컨테이너 삭제

```bash
sudo docker rm f6e513b3999a6 # 컨테이너 삭제
```



## 이미지 비밀 레이어

> 이미지 다운로드시 여러 레이어가 다운로드 된다. 
> 도커에 저장시 일치하는 레이어들은 유지하고 일치하지 않은 레이어만 백업해서 저장한다고 한다.

![image-20210131204915012](http://www.jimbae.com:59005/image/90)

* 레이어 A, B, C 는 중복되기 때문에 이미지 A가 존재하는 상태에서 이미지 B를 다운로드 해도 A, B, C 는 다운하지 않는다
* 삭제할때도 마찬가지로 이미지 A를 삭제하더라도 이미지 B에서 사용하고 있으므로 실질적으로 레이어 A, B, C 는 삭제되지 않는다.



#### 이미지 정보 확인

```bash
sudo docker inspect nginx
```



#### 도커 이미지 저장소 위치 확인

```bash
sudo docker info 
```



#### 도커 이미지 히스토리 확인

```bash
sudo docker history nginx
```





### 실습

![image-20210131205304730](http://www.jimbae.com:59005/image/91)

* /var/lib/docker 접속시 도커의 파일 구조를 확인할수 있다
  * image : 이미지에 대한 정보 저장
  * container : 컨테이너에 대한 정보 저장
  * overlay2 : 실제 레이어 저장 경로 [주 데이터를 들고 있으므로 mount 로 구성하면 좋다]
    * l : 도커에서 사용되는 실제 파일들이 저장되 있는것을 볼수 있다 





## 도커의 유용한 명령어



#### 포트포워딩으로 톰캣 실행하기

```bash
sudo docker run -d --name tc -p 80:8080 tomcat #-d : 백그라운드 실행, --name : 명명하기, -p x:c X로 접속시 c로 포트포워딩
```



#### 컨테이너 내부 셸 실행

````bash
sudo docker exec -it tc /bin/bash #자세한 구동정보 조회용 명령어
````



#### 컨테이너 로그 확인

```bash
sudo docker logs tc #stdout, stderr
```



#### 호스트 및 컨테이너 간 파일 복사

```bash
sudo docker cp <path> <to container>:<path>
sudo docker cp <from container>:<path> <path>
sudo docker cp <from container>:<path> <to container>:<path>
```


#### 임시 컨테이너 생성

```bash
sudo docker run -d -p 80:8080 --rm --name tc tomcat #--rm : 임시 컨테이너, 내리면 자동 삭제
```



## 연습예제

1. 기존에 설치된 모든 컨테이너와 이미지 정지 및 삭제

   ```bash
   [내 풀이]
   docker rmi `docker images -q`
   docker rm `docker ps -a -q`
   
   [답안]
   docker stop `docker ps -a -q`
   docker rm `docker ps -a -q`
   docker rmi `docker images -q`
   ```

   

2. 도커 기능을 사용해 Jenkins 검색

   ```bash
   [내 풀이]
   docker search jenkins
   
   [답안]
   docker search jenkins
   ```

   

3. Jenkins를 사용하여 설치

   ```bash
   [내 풀이]
   docker run -d -p 8080:8080 --name jk jenkins
   
   [답안]
   docker pull jenkins # 안되서 https://hub.docker.com/_/jenkins?tab=tags&page=1&ordering=last_updated 를 방문해서 버전 직접 설정
   docker inspect jenkins # 포트 확인
   docker run -d -p 8080:8080 --name jk jenmkins
   ```



4. Jenkins 포트로 접속하여 웹서비스 열기

   ```bash
   [답안]
   firefox 127.0.0.1:8080
   ```

   

5. Jenkins의 초기 패스워드 찾아서 로그인 하기

   ```bash
   [내 풀이]
   docker exec -it jk /bin/bash
   cd /var/jenkins_home/secrets
   cat initialAdminPassword # 암호확인하여 로그인
   
   [답안]
   docker exec -it jk cat /path/initPassword
   docker logs jk #시작할떄 initPassword 를 stdout 으로 출력해줌
   
   ```

   



## 환경 변수 사용해 MySQL 서비스 구축하기

### Docker Hub 에서 Mysql 검색하기

* https://hub.docker.com/_/mysql

* MySQL 의 경우 단순히 다운받아서 이용하는 것이 아닌 아이디와 패스워드를 입력하여서 설치하여야 한다.

![image-20210203213700988](http://www.jimbae.com:59005/image/107)

* -e [env] : 옵션을 이용하여, 환경 변수를 설정해 줘서 설치를 해야 한다.
  * 초기 패스워드를 변경하지 않고 사용할 경우 보안의 취약해 질수 있다. 
  * 환경 변수를 사용하면, 이러한 보안적 사항을 강제할수 있는 장점이 있다.
  * 또한 패스워드를 변경하고자 하는 이들은 초기 설치시 환경변수를 이용할수 있으므로 편리함을 챙길수 있다.



### 환경 변수 사용해 데이터 전달 연습

```bash
docker run -d --name nx -e env_name=test1234 nginx
```

![image-20210203215616286](http://www.jimbae.com:59005/image/108)

* 말그대로 환경변수 등록이다.
* 암호와 같은것은 평문으로 저장된다 > 보안의 위험이 없지는 않은듯 하다. > 질문) **너무 위험한데..... 보안 방법은 없나?**



### MySQL 서비스 구축하기

```bash
docker run --name ms -e MYSQL_ROOT_PASSWORD='test1234' -d mysql
docker exec -it ms mysql -u root -p
password : test1234
```



## 불륨 마운트하기

* 명령어 형식

```bash
docker run -v <호스트 경로>:<컨테이너 내 경로>:<권한>
```

* <호스트 경로> : 마운트할 로컬 경로
* <컨테이너 내 경로> : 컨테이너 내 마운트를 할 경로
* <권한>
  * ro : 읽기 전용
  * rw : 읽기 및 쓰기



#### nginx로 볼륨 마운트하기

```bash
docker run -d -p 80:80 --rm --name nx -v /var/www:/usr/share/nginx/html:ro nignx
curl 127.0.0.1
echo 1234 > /var/www/index.html
curl 127.0.0.1
```

